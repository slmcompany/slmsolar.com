---
import Layout from "../../layouts/Layout.astro";
import fetchApi from "../../lib/strapi.ts";
import type Projects from "../../interfaces/projects.ts";
import { format } from 'date-fns';
import { vi } from 'date-fns/locale';

export async function getStaticPaths({}) {
    const projects: Array<Projects> = await fetchApi({
        endpoint: "blogs?populate=image", // the content type to fetch
        wrappedByKey: "data",
    });

    return projects.map((project: any) => ({
        params: { slug: project.attributes.slug },
        props: project,
    }));
}

const project = Astro.props;
const publishDate = new Date(project.attributes.publishedAt);
const formattedDate = format(publishDate, 'dd MMMM, yyyy', { locale: vi });

// Estimate read time (roughly 200 words per minute)
const wordCount = project.attributes.content ? project.attributes.content.split(/\s+/).length : 0;
const readingTime = Math.ceil(wordCount / 200) || 1; // Minimum 1 minute read time
---

<Layout title={project.attributes.title}>
    <article class="bg-white">
        <!-- Header section -->
        <header class="bg-white shadow">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <h2 class="text-2xl font-bold leading-7 text-gray-900">Dự án</h2>
            </div>
        </header>

        <!-- Main content -->
        <div class="relative px-6 py-12 lg:px-8">
            <div class="mx-auto max-w-7xl">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                    <!-- Video Section - Left (1/3) -->
                    {project.attributes.youtube_id && project.attributes.image?.data && (
                        <div class="lg:col-span-4 relative w-[360px] mx-auto lg:mx-0">
                            <div class="relative" style="padding-top: 177.78%"> <!-- 9:16 aspect ratio -->
                                <iframe
                                    class="absolute inset-0 w-full h-full rounded-xl shadow-lg"
                                    src={`https://www.youtube.com/embed/${project.attributes.youtube_id}?rel=0`}
                                    title={project.attributes.title}
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    allowfullscreen
                                ></iframe>
                            </div>
                        </div>
                    )}

                    <!-- Title and Meta Section - Right (2/3) -->
                    <div class="lg:col-span-8 flex flex-col">
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl mb-4">
                            {project.attributes.title}
                        </h1>
                        <div class="flex items-center space-x-4 text-gray-600 text-sm mb-8">
                            <time datetime={project.attributes.publishedAt}>{formattedDate}</time>
                            <span>•</span>
                            <span>{readingTime} phút đọc</span>
                            {project.attributes.category && (
                                <>
                                    <span>•</span>
                                    <span>{project.attributes.category}</span>
                                </>
                            )}
                        </div>

                        <!-- Project details -->
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mb-8">
                            {project.attributes.vi_tri && (
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                    </svg>
                                    <span class="text-gray-600">{project.attributes.vi_tri}</span>
                                </div>
                            )}
                            {project.attributes.cong_suat && (
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" />
                                    </svg>
                                    <span class="text-gray-600">{project.attributes.cong_suat}kWp</span>
                                </div>
                            )}
                            {project.attributes.loai_he_thong && (
                                <div class="flex items-center space-x-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" />
                                    </svg>
                                    <span class="text-gray-600">{project.attributes.loai_he_thong}</span>
                                </div>
                            )}
                        </div>

                        {project.attributes.description && (
                            <div class="prose prose-lg prose-green text-gray-500 leading-8">
                                {project.attributes.description}
                            </div>
                        )}
                    </div>
                </div>

                <!-- Main content -->
                <div class="mt-12 prose prose-lg prose-green mx-auto">
                    <div set:html={project.attributes.content} />
                </div>
            </div>
        </div>
    </article>
</Layout>
