---
import Layout from '../../layouts/Layout.astro'
import UnavailableContent from '../../components/UnavailableContent.astro';

// Không còn sử dụng API Strapi
// import fetchApi from "../../lib/strapi.ts"
// import type Product from "../../interfaces/products.ts"

// Import icons từ heroicons
import {
  BuildingOfficeIcon,
  TagIcon,
  ShieldCheckIcon,
  CpuChipIcon,
  BoltIcon,
  Square3Stack3DIcon,
  ScaleIcon,
  ChartBarIcon,
  ArrowRightCircleIcon,
  Battery50Icon,
  Battery100Icon,
  WrenchScrewdriverIcon,
  PlusIcon,
  RectangleStackIcon,
  CheckCircleIcon,
  SparklesIcon,
  PuzzlePieceIcon,
  DevicePhoneMobileIcon
} from '@heroicons/react/24/outline';

// Interface cho thông số kỹ thuật
interface Specs {
  brand?: string;
  technology?: string;
  cell?: string;
  power?: string;
  dimensions?: string;
  weight?: string;
  protection?: string;
  efficiency?: string;
  capacity?: string;
  cellType?: string;
  voltage?: string;
  installation?: string;
  maxPacks?: string;
  features?: string[] | string;
  components?: string[];
  type?: string;
  material?: string;
  resistance?: string;
  standards?: string;
  dcInput?: string;
  batteryVoltage?: string;
  maxDC?: string;
  additionalFeature?: string;
  thuonghieu?: string;
}

// Interface cho cấu hình hiển thị spec
interface SpecConfig {
  key: keyof Specs;
  label: string;
  icon: any;
}

// Cấu hình hiển thị thông số kỹ thuật với biểu tượng
const specConfigs: SpecConfig[] = [
  // Thông số chung
  { key: 'brand', label: 'Thương hiệu', icon: BuildingOfficeIcon },
  { key: 'type', label: 'Loại', icon: TagIcon },
  { key: 'protection', label: 'Bảo vệ', icon: ShieldCheckIcon },
  
  // Pin quang năng
  { key: 'technology', label: 'Công nghệ', icon: CpuChipIcon },
  { key: 'cell', label: 'Cell pin', icon: DevicePhoneMobileIcon },
  { key: 'power', label: 'Công suất', icon: BoltIcon },
  { key: 'dimensions', label: 'Kích thước', icon: Square3Stack3DIcon },
  { key: 'weight', label: 'Khối lượng', icon: ScaleIcon },
  { key: 'efficiency', label: 'Hiệu suất', icon: ChartBarIcon },

  // Biến tần
  { key: 'dcInput', label: 'Đầu vào DC', icon: ArrowRightCircleIcon },
  { key: 'batteryVoltage', label: 'Điện áp pin', icon: Battery50Icon },
  { key: 'maxDC', label: 'DC tối đa', icon: BoltIcon },

  // Pin lưu trữ
  { key: 'capacity', label: 'Dung lượng', icon: Battery100Icon },
  { key: 'cellType', label: 'Loại cell', icon: DevicePhoneMobileIcon },
  { key: 'voltage', label: 'Điện áp', icon: ArrowRightCircleIcon },
  { key: 'installation', label: 'Lắp đặt', icon: WrenchScrewdriverIcon },
  { key: 'maxPacks', label: 'Mở rộng', icon: PlusIcon },

  // Phụ kiện
  { key: 'material', label: 'Vật liệu', icon: RectangleStackIcon },
  { key: 'resistance', label: 'Điện trở', icon: ScaleIcon },
  { key: 'standards', label: 'Tiêu chuẩn', icon: CheckCircleIcon },
];

// Định nghĩa các danh mục cho sidebar
const categories = [
  { 
    name: "Pin quang năng", 
    href: "#pinquangnang", 
    id: "pinquangnang",
    submenu: [
      { name: "JA Solar", href: "#jasolar" },
      { name: "Longi Solar", href: "#longisolar" }
    ]
  },
  { 
    name: "Biến tần", 
    href: "#bientan", 
    id: "bientan",
    submenu: [
      { name: "Biến tần Hybrid", href: "#hybrid" },
      { name: "Biến tần Ongrid", href: "#ongrid" }
    ]
  },
  { 
    name: "Pin lưu trữ", 
    href: "#pinluutru", 
    id: "pinluutru",
    submenu: [
      { name: "Pin lưu trữ áp thấp", href: "#pinluutru-ap-thap" },
      { name: "Pin lưu trữ áp cao", href: "#pinluutru-ap-cao" }
    ]
  },
  { 
    name: "Phụ kiện", 
    href: "#phukien", 
    id: "phukien",
    submenu: [
      { name: "Tủ điện", href: "#tudien" },
      { name: "Hệ tiếp địa", href: "#hetiepdia" }
    ]
  },
];

// Định nghĩa interface cho danh mục sản phẩm
interface ProductCategory {
  title: string;
  products: any[]; // Changed from Products[] to fix error
  description: string;
}

// Nhóm sản phẩm theo danh mục
const categoryMapping: Record<string, string> = {
  // Các tên danh mục gốc
  "Pin quang năng": "pinquangnang",
  "Biến tần": "bientan",
  "Pin lưu trữ": "pinluutru",
  "Phụ kiện": "phukien",
  
  // Thêm các tên danh mục dạng khác (không dấu, viết thường) để đảm bảo tương thích
  "pin quang nang": "pinquangnang",
  "bien tan": "bientan", 
  "pin luu tru": "pinluutru",
  "phu kien": "phukien",
  
  // Thêm các tên danh mục tiếng Anh có thể có
  "solar panels": "pinquangnang",
  "inverter": "bientan",
  "battery": "pinluutru",
  "accessories": "phukien",
  
  // Thêm các ID danh mục có thể được trả về từ API
  "1": "pinquangnang",
  "2": "bientan",
  "3": "pinluutru",
  "4": "phukien"
};

const productsByCategory: Record<string, ProductCategory> = {};

// Khởi tạo các danh mục trước
Object.keys(categoryMapping).forEach(catName => {
  const catId = categoryMapping[catName];
  if (catId) {
    productsByCategory[catId] = {
      title: catName,
      products: [],
      description: ""
    };
  }
});

// Thiết lập mô tả cho các danh mục
productsByCategory["pinquangnang"].description = "Pin quang năng là thiết bị chuyển đổi năng lượng mặt trời thành điện năng sạch, giúp giảm thiểu tác động tiêu cực đến môi trường và tiết kiệm chi phí.";
productsByCategory["bientan"].description = "Biến tần là thiết bị chuyển đổi điện một chiều từ tấm pin mặt trời thành điện xoay chiều để sử dụng cho các thiết bị điện trong gia đình và doanh nghiệp.";
productsByCategory["pinluutru"].description = "Pin lưu trữ là thiết bị tích trữ điện năng, giúp bảo vệ hệ thống điện khi có sự cố hoặc khi không có ánh nắng mặt trời.";
productsByCategory["phukien"].description = "Các phụ kiện đi kèm giúp tối ưu hóa hiệu suất và kéo dài tuổi thọ của hệ thống điện mặt trời.";

// Phân loại sản phẩm vào các danh mục
// Code này không còn cần thiết vì không còn sử dụng Strapi API
/* 
productsArray.forEach(product => {
  if (product.attributes) {
    // Ưu tiên sử dụng trường categories
    if (product.attributes.categories) {
      // Xử lý trường hợp categories là một mảng
      const categoriesList = Array.isArray(product.attributes.categories) 
        ? product.attributes.categories 
        : [product.attributes.categories];
      
      // Kiểm tra từng category trong danh sách
      let foundCategory = false;
      
      for (const catName of categoriesList) {
        const catId = categoryMapping[catName];
        if (catId && productsByCategory[catId]) {
          productsByCategory[catId].products.push(product);
          foundCategory = true;
          break; // Chỉ thêm vào danh mục đầu tiên tìm thấy
        }
      }
      
      // Nếu không tìm thấy danh mục nào phù hợp, thêm vào phụ kiện
      if (!foundCategory) {
        productsByCategory["phukien"].products.push(product);
      }
    } 
    // Sử dụng trường category cũ nếu không có trường categories
    else if (product.attributes.category) {
      const catName = product.attributes.category;
      const catId = categoryMapping[catName];
      
      if (catId && productsByCategory[catId]) {
        productsByCategory[catId].products.push(product);
      } else {
        // Nếu không xác định được danh mục, đặt mặc định vào danh mục "Phụ kiện"
        productsByCategory["phukien"].products.push(product);
      }
    } else {
      // Nếu không có thuộc tính category hoặc categories, đặt vào danh mục "Phụ kiện"
      productsByCategory["phukien"].products.push(product);
    }
  }
});

// Tính toán xem có bao nhiêu danh mục có sản phẩm
const activeCategoryCount = Object.values(productsByCategory).filter(
  (cat: ProductCategory) => cat.products.length > 0
).length;

// Loại bỏ các danh mục trùng lặp trong trường hợp một sản phẩm được đặt vào nhiều danh mục
Object.values(productsByCategory).forEach(category => {
  // Đảm bảo không có sản phẩm trùng lặp trong cùng một danh mục
  const uniqueProductIds = new Set();
  category.products = category.products.filter(product => {
    if (uniqueProductIds.has(product.id)) {
      return false;
    }
    uniqueProductIds.add(product.id);
    return true;
  });
});
*/

// Giá trị mặc định để tránh lỗi khi không có dữ liệu từ API
const activeCategoryCount = 0;
---

<Layout title="Thiết bị">
  <div class="relative overflow-hidden bg-white">
    <div class="mx-auto max-w-7xl">
      <div class="relative z-10 pb-8 sm:pb-16 md:pb-20 lg:w-full lg:max-w-2xl lg:pb-28 xl:pb-32">
        <main class="mx-auto px-4 sm:px-6 lg:px-8">
          <UnavailableContent 
            title="Danh mục thiết bị đang được cập nhật" 
            description="Nội dung về thiết bị hiện không khả dụng do chúng tôi đang tiến hành nâng cấp hệ thống. Vui lòng quay lại sau."
          />
        </main>
      </div>
    </div>
  </div>
</Layout>
